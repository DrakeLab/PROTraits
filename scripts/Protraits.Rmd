---
title: "Protraits"
author: "Joy Vaz"
date: "October 16, 2019"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_chunk$set(echo=T, tidy=T, warning=F, message=F)
opts_knit$set(root.dir = "C:/Protraits_Joy/")
```

## Data Processing

```{r data wrangling}

### Attach packages

library(tidyverse) 
library(dplyr) 
library(stringr)

### Import data ----------------------------------------------------------------------------

## Global Mammal Parasite Database (GMPD) 2.0

# Database of the parasites of wild primates, carnivores and ungulates. See metadata for more info. Data published in Stephens et al. (2017) at ttp://onlinelibrary.wiley.com/doi/10.1002/ecy.1799/suppinfo. Downloaded on 20180911. 

gmpdprot <- read_csv("data/original/GMPD_datafiles/GMPD_main.csv") %>% 
  filter(ParType == "Protozoa", HasBinomialName == "yes", !grepl("no binomial name", HostCorrectedName)) %>% 
  select(hosttype=Group, hostname=HostCorrectedName, hostorder=HostOrder, hostfamily=HostFamily, hostenv=HostEnvironment, 
         location=LocationName, lat=Latitude, long=Longitude, 
         gmpdprotname=ParasiteCorrectedName, 
         prev=Prevalence, 
         numhosts=HostsSampled, numsamples=NumSamples) %>% 
  mutate(ID = seq(len=2484))  # give unique ID to each GMPD record 

gmpdtaxo <- read_csv("data/original/GMPD_datafiles/GMPD_parasite_taxonomy.csv") %>% # rows are unique parasite species, columns are taxonomic classifications of each species
  filter(ParType == "Protozoa", HasBinomialName == "yes") %>% 
  select(gmpdprotname=ParasiteCorrectedName, 
         parphylum=ParPhylum, parclass=ParClass, parorder=ParOrder, parfamily=ParFamily) %>% 
  distinct()

# Save as flat files
#write_csv(gmpdprot, "data/modified/gmpdprot.csv")
#write_csv(gmpdtaxo, "data/modified/gmpdtaxo.csv")

## Zooscores

# Database of the zoonotic statuses of protozoa in GMPD. See metadata for more info. Data (unpublished) from Han lab, Cary Institute of Ecosystem Studies. Recieved from Barbara Han on 20180806.

prots178 <- read_csv("data/original/Zooscore_datafiles/Zooscore_trait_Protozoa.csv") %>% 
  select(protname=ParasiteCorrectedName_Zooscores_VR_Ver5.0_Final, 
         zscore=XC_ZooScore, cscore=XC_CScore, 
         gmpdprotname=ParasiteCorrectedName.updated, 
         tm_close=close, tm_nonclose=nonclose, tm_vector=vector, tm_intermediate=intermediate, 
         parphylum=ParPhylum, parclass=ParClass, parorder=ParOrder, parfamily=ParFamily)

# Save as flat file
#write_csv(prots178, "data/modified/prots178.csv")

prots049 <- read_csv("data/modified/48prots.csv") %>% # 49 additional protozoa that have zooscores but no tranmission mode traits recorded in GMPD_parasite_traits.csv, plus E. histolytica which got added to this list instead of the original 178.
  rename(protname=ParasiteCorrectedName_Zooscores_VR_Ver5.0_Final, 
         zscore=XC_ZooScore, cscore=XC_CScore) %>% 
  mutate(gmpdprotname=protname, tm_close=NA, tm_nonclose=NA, 
         tm_vector=NA, tm_intermediate=NA) %>% 
  left_join(gmpdtaxo)

# Save as flat file
#write_csv(prots049, "data/modified/prots049.csv")

# Join prots178 and prots049
prots226 <- rbind(prots178, prots049)


### Clean data ----------------------------------------------------------------------------

## Names

# Check  for discrepencies in gmpdprotnames between the two dataframes 
setdiff(prots226$gmpdprotname, gmpdprot$gmpdprotname) # 1 spp in prots226 does is not listed gmpdprot - this is because its host does not have a binomial name and was filtered out above. 

# Remove T. brimonti from prots226
prots226 <- prots226 %>% filter(!grepl("Trypanosoma brimonti", protname))

# Check for discrepencies between final protnames and gmpdprotnames
setdiff(prots226$protname, gmpdprot$gmpdprotname) # the final protnames in prots226 contains 2 corrected protnames that have been updated from the original gmpdprotname

# Create protname variable in gmpd for final protnames
gmpdprot <- gmpdprot %>% mutate(protname = gmpdprotname)

# Update the 2 spp names to match zooscore
gmpdprot$protname <- gsub("Cystoisospora canis", "Isospora canis", gmpdprot$protname)
gmpdprot$protname <- gsub("Plasmodium malariae", "Plasmodium rodhaini", gmpdprot$protname)

# Verify that the protnames in both datasets are now matching
setdiff(prots226$protname, gmpdprot$protname)

## Completeness

# Save a list of the gmpdprot spp that are not in prots226
noscores <- as.data.frame(setdiff(gmpdprot$protname, prots226$protname)) %>% rename(protname = `setdiff(gmpdprot$protname, prots226$protname)`)


### Create protraits ----------------------------------------------------------------------------

# Add prots226 data to gmpdprot to create protraits. Each row is a unique host-parasite interaction
protraits_01 <- left_join(prots226, gmpdprot, by = "protname") %>% 
  select(ID, protname, hostname, zscore, cscore, 
         tm_close, tm_nonclose, tm_vector, tm_intermediate, 
         parphylum, parclass, parorder, parfamily,
         hosttype, hostorder, hostfamily, hostenv,
         lat, long, location, numhosts, numsamples, prev)

# Add binary var to protraits indicating zoonotic status of each prot spp
for (i in 1:length(protraits_01$protname)) {
  if(protraits_01$zscore[i] > 0){
    protraits_01$zoostat[i] <- 1
  } else {
    protraits_01$zoostat[i] <- 0
  }
}

# Verify that protraits has 226 prot species
length(unique(protraits_01$protname))

# Create tbl of all unique prot spp names (n = 226)
allprots <- as.tbl(as.data.frame(unique(protraits_01$protname))) %>% 
  rename(protname = `unique(protraits_01$protname)`)

# Create tbl of all unique host spp names (n = 245)
allhosts <- as.tbl(as.data.frame(unique(protraits_01$hostname))) %>% 
  rename(hostname = `unique(protraits_01$hostname)`)

# Create tbl of all unique host-parasite interaction pairs (n = 840)
allintrx <- protraits_01 %>% select(hostname, protname) %>% distinct() %>% as.tbl() %>% 
  mutate(pairname = paste(protname, ", ", hostname))


# Save as flat files
#write_csv(allprots, "data/modified/allprots.csv")
#write_csv(allhosts, "data/modified/allhosts.csv")
#write_csv(allintrx, "data/modified/allintrx.csv")

```

## Mammal trait data

```{r mammal traits}

pantheria <- read.delim("data/original/PanTHERIA/pan.txt") %>% 
  select(-c(MSW93_Order, MSW93_Family, MSW93_Genus, MSW93_Species)) %>%
  rename(hostname = MSW93_Binomial) 

phylacine <- read_csv("data/original/PHYLACINE_datafiles/Trait_data.csv")

phylacine$hostname = gsub("_", " ", phylacine$Binomial.1.2)

hosttraits <- left_join(allhosts, gmpdprot[,1:5])
hosttraits <- left_join(hosttraits, pantheria)
hosttraits <- left_join(hosttraits, phylacine)



```

## TEOW Ecoregions


```{r ecoregions}

library(sf)

# Assign a ecoregion data to each host-parasite location

intrxpts <- protraits_01 %>% select(ID, lat, long) %>% na.omit() # Extract lat long coordinates for each intrx. 86 host-prot intrx do not have coordinates in GMPD
intrxgeo <- intrxpts %>% st_as_sf(coords = c("long","lat"), crs=4326) # convert to sf object
 
### Import data ----------------------------------------------------------------------------

## WWF Terrestrial Ecoregions of the World (TEOW)

# Spatial polygons dataset downloaded from https://www.worldwildlife.org/publications/terrestrial-ecoregions-of-the-world on 

teowshps <- st_read("./data/original/WWF_ecoregions_datafiles/wwf_terr_ecos.shp") 
#
#
## Create df with each point and corresponding TEOW vars
#teowprot <- st_intersection(teowshps, intrxgeo) %>% 
#  as.data.frame()
#
## Save as flat file
#write_csv(teowprot, "data/modified/teowprot.csv")

teowprot <- read_csv("data/modified/teowprot.csv")

protraits_02 <- left_join(protraits_01, teowprot %>% select(ID, ECO_NAME, REALM, BIOME), by = "ID") #protraits should now have 27 vars

# Create df of the protraits records that did NOT overlap with TEOW polygons
noteows <- anti_join(protraits_01, teowprot, by = "ID") # 160 records did not match, 86 of which do not have lat long coordinates in GMPD
length(noteows$lat %>% na.omit()) # 74 records have lat/longs but still did not overlap with TEOW polygons because they were off the coast in marine ecoregions.

# Plot map of global distribution of GMPD protozoa records across TEOW biomes

biome_names <- c("Tropical & Subtropical Moist Broadleaf Forests", 
                 "Tropical & Subtropical Dry Broadleaf Forests", 
                 "Tropical & Subtropical Coniferous Forests", 
                 "Temperate Broadleaf & Mixed Forests", 
                 "Temperate Conifer Forests", 
                 "Boreal Forests/Taiga", 
                 "Tropical & Subtropical Grasslands, Savannas & Shrublands", 
                 "Temperate Grasslands, Savannas & Shrublands", 
                 "Flooded Grasslands & Savannas", 
                 "Montane Grasslands & Shrublands", 
                 "Tundra", 
                 "Mediterranean Forests, Woodlands & Scrub", 
                 "Deserts & Xeric Shrublands", 
                 "Mangroves", 
                 "Lake", 
                 "Rock & Ice")

biome_colors <- c("#2c3100",
                  "#707d37",
                  "#1a4910",
                  "#437c44",
                  "#00765a",
                  "#008fac",
                  "#843a29",
                  "#9f8075",
                  "#6e480e",
                  "#312c1e",
                  "#015281",
                  "#5c2f00",
                  "#a68052",
                  "#7b6f29",
                  "#017db5",
                  "#00325f")
# view colours
#pie(rep(1,16), col = biome_colors, labels = biome_names)

biome_map <- ggplot(teowshps) +
  geom_sf(aes(fill = as.factor(BIOME))) +
  scale_fill_manual(values = biome_colors, name = "Terrestrial Biome", labels = biome_names)

biome_map +
  xlab("Longitude") + ylab("Latitude") +
  ggtitle("Global distribution of protozoa records in GMPD") +
  geom_point(data = intrxpts, aes(x = long, y = lat),  color = "#fffffa", alpha = 0.5, size = 1) +
  theme(panel.background = element_rect(fill = "azure"), legend.position = "bottom") +
  coord_sf(crs = 4326)

# plot global distribution of GMPD protozoa records by country 

#library(rnaturalearth)
#library(rnaturalearthdata)
#
#world <- ne_countries(scale = "medium", returnclass = "sf")
#class(world)
#
#ggplot() +
#  geom_sf(data = world, aes(fill = gdp_md_est/pop_est), color = "black") +
#  xlab("Longitude") + ylab("Latitude") +
#  ggtitle("Global distribution of protozoa records in GMPD") +
#  scale_fill_viridis_c(option = "plasma", trans = "sqrt") +
#  geom_point(data = host_par_points_df, aes(x = long, y = lat)) 

```

```{r bipartite network}
###Host-Prasite Bipartite Network

library(igraph)
library(bipartite)

# create df from which to build network
hostprotnetwork <- read_csv("./data/modified/allpairs.csv") %>% 
  select(protname, hostname) %>% mutate(netID = "1")

## Setup for bipartite

# convert to web format needed for bipartite functions
web <- frame2webs(hostprotnetwork, varnames = c("protname", "hostname", "netID"))

# calculate bipartite network indices for all prots and hosts
protsnet <- specieslevel(web[["1"]], level = "lower", index = c("normalised degree", "betweenness", "closeness", "proportion generality"))
hostsnet <- specieslevel(web[["1"]], level = "higher", index = c("normalised degree", "betweenness", "closeness", "proportion generality"))

# convert to bipartite network one-mode network in order to calculate indices like centrality
#as.one.mode(web[["1"]])

#_____________________________________________________________________________________________

## Setup for igraph

# convert to graph format needed for igraph functions

g <- graph.data.frame(hostprotnetwork[,1:2], directed = F)

bipartite.mapping(g)  # $res tells us if the network meets the criteria for a 2-mode network ($res)
# and $type tells us which nodes fall into each mode - FALSE for prots and TRUE for hosts

# check: number of nodes should equal the total number of unique host + parasite spp.
length(bipartite.mapping(g)$type) - length(unique(union(hostprotnetwork$protname, hostprotnetwork$hostname))) 

# add the 'type' attribute to the network
V(g)$type <- bipartite_mapping(g)$type

### Visualise (not very useful because network is so large)
#V(g)$label.color <- "black" 
#V(g)$label.cex <- 0.65 
#V(g)$frame.color <-  "gray"
#V(g)$size <- 15
#
#plot(g, layout = layout_with_graphopt)
#
#plot(g, layout=layout.bipartite, vertex.size=7, vertex.label.cex=0.6)

## Analysis

#Used code from this tutorial: https://rpubs.com/pjmurphy/317838

#From the tutorial page:
#Igraph was not designed with two-mode networks in mind. It does, however recognize that the network is two-mode. 
#Keep in mind, however, that when you run centrality measures on a two-mode network, igraph will be treating each 
#of these nodes as though they are in the same mode. Igraph makes no allowance for calculating centralities that 
#are specific to the special case of two-mode networks.
#If you are interested in understanding the relative prominence of nodes in each mode, relative to other nodes in that mode, 
#then the best you will be able to do in igraph will be to analyze each mode separately. 

m <- as.one.mode(web[["1"]])
mgraph <- graph.adjacency(m)

#Calculate centrality
types <- V(g)$type                 # get each vertex `type` in order to sort easily
deg <- degree(m)
bet <- betweenness(m)
clos <- closeness(m)
eig <- eigen_centrality(mgraph)$vector

protsnet <- left_join(x = specieslevel(web[["1"]], level = "lower", 
                                   index = c("normalised degree", "betweenness", "closeness")) %>% 
                        rownames_to_column("protname"), 
                      y = data.frame(types, deg, bet, clos, eig) %>% 
                        rownames_to_column("protname") %>% 
                        mutate(types = as.character(types)) %>% 
                        filter(types == "FALSE"))

hostsnet <- left_join(x = specieslevel(web[["1"]], level = "higher", 
                                       index = c("normalised degree", "betweenness", "closeness")) %>% 
                        rownames_to_column("hostname"), 
                      y = data.frame(types, deg, bet, clos, eig) %>% 
                        rownames_to_column("hostname") %>% 
                        mutate(types = as.character(types)) %>% 
                        filter(types == "TRUE"))
# Save as csvs
#write.csv(protsnet, "./data/modified/protsnet.csv")
#write.csv(hostsnet, "./data/modified/hostsnet.csv")

# Add protsnet vars to protratis
protraits_03 <- left_join(protraits_02, protsnet, by = "protname") #protraits should now have 38 vars

```

```{r specialism generalism}

#mammal supertree
library(ape)
treelist=read.nexus("data/original/Park_2016/WR_2005_ST.txt")
#best dates
mtree=treelist[[1]]
#dist matrix
phydist<-cophenetic.phylo(mtree) #or can use generic cophenetic
#which hosts are in the parasite database
d<-read.csv("data/original/Park_2016/GMPD_main_2016-11-28.csv",header=T)
d<-subset(d,HostEnvironment=="terrestrial")
keep.d<-which(names(d)%in%c("HostCorrectedName","HostOrder","ParasiteCorrectedName","Par.Type","Group"))
d<-d[,keep.d]
#remove rows where host is not identified to species
d<-d[-which(d$HostCorrectedName=="no binomial name"),]
#remove rows where parasite is not identified to species
d<-d[-which(d$ParasiteCorrectedName=="no binomial name"),]
d<-d[-which(d$ParasiteCorrectedName=="not identified to genus"),]
#Sys.setlocale('LC_ALL','C') 
d<-d[-grep("sp\\.",d$ParasiteCorrectedName),]
## merge transmission mode data
ptrans<-read.csv("data/original/Park_2016/GMPD_parasite_traits_2016-11-28.csv",header=T)
ptrans<-subset(ptrans,select=c("ParasiteCorrectedName","close","nonclose","vector","intermediate"))
d<-merge(d,ptrans,by="ParasiteCorrectedName")
# identify host species in gmpd
obs.hosts<-unique(d$HostCorrectedName)
obs.hosts<-gsub(" ","_",obs.hosts) #put in underscore for compatibility with other dataframe
#at which locations of phydist do these hosts occur?
idx<-which(unlist(dimnames(phydist)[1]) %in% obs.hosts)
#pull out smaller cophenetic matrix of only these hosts
phydist.mini<-phydist[idx,idx]
#make a community matrix for the call to ses.mpd
d$HostCorrectedName<-gsub(" ","_",d$HostCorrectedName)
d$HostCorrectedName<-as.factor(d$HostCorrectedName)
d<-droplevels(d)
comm<-as.data.frame.matrix(table(d[,c(which(names(d)=="ParasiteCorrectedName"),which(names(d)=="HostCorrectedName"))]))
#comm<-1*(comm>0)
#get normalized z-score for mpd
library(picante)
phydist.mini<-phydist.mini[order(rownames(phydist.mini)),order(rownames(phydist.mini))]

# Two -------------------------------

nri<-ses.mpd(comm,phydist.mini,null.model="independentswap",runs=10,abundance.weighted=T)#change back to 1000!

#load("get_nri.Rda") #nri<-ses.mpd(comm,phydist.mini,null.model="independentswap",runs=1000,abundance.weighted=T)
load("data/original/Park_2016/get_nriABUND.Rda") #nri<-ses.mpd(comm,phydist.mini,null.model="independentswap",runs=1000)

# prep to merge with other dataframe that has other parasite traits
#nri<-nri[complete.cases(nri),]  # THIS REMOVES SINGLETON PARASITES (ONLY ONE HOST) SINCE MPD STUFF IS NA
nri$ParasiteCorrectedName<-rownames(nri)
nri<-merge(nri,ptrans,by="ParasiteCorrectedName")

ptype<-read.csv("data/original/Park_2016/GMPD_parasite_taxonomy_2016-11-28.csv",header=T)
ptype<-subset(ptype,select=c("ParasiteCorrectedName","ParType"))
ptype<-ptype[!duplicated(ptype),]
nri<-merge(nri,ptype,by="ParasiteCorrectedName")

#remove rare parasite types
nri4<-nri[-which(nri$ParType %in% c("Fungus","Prion")),]#c("Fungus","Prion")

nri4$n.modes<-rowSums(cbind(nri4$close,nri4$nonclose,nri4$vector,nri4$intermediate))
nri6<-nri4
names(nri6)[which(names(nri6)=="ParasiteCorrectedName")]<-"para.name"
names(nri6)[which(names(nri6)=="ParType")]<-"para.type"
nri6$para.name<-as.character(nri6$para.name)
nri6<-nri6[complete.cases(nri6),]

nri.flat<-data.frame(para.name=character(),ntaxa=integer(),mpd.obs.z=numeric(),mpd.obs.p=numeric(),para.type=character(),tmode=character(),stringsAsFactors=FALSE)
k<-1
for (i in 1:dim(nri6)[1]){
  if (nri6[i,"close"]==1){nri.flat[k,"para.name"]<-nri6[i,"para.name"];nri.flat[k,"ntaxa"]<-nri6[i,"ntaxa"];nri.flat[k,"mpd.obs.z"]<-nri6[i,"mpd.obs.z"];nri.flat[k,"mpd.obs.p"]<-nri6[i,"mpd.obs.p"];nri.flat[k,"para.type"]<-as.character(nri6[i,"para.type"]);nri.flat[k,"tmode"]<-"close";k<-k+1}
  if (nri6[i,"nonclose"]==1){nri.flat[k,"para.name"]<-nri6[i,"para.name"];nri.flat[k,"ntaxa"]<-nri6[i,"ntaxa"];nri.flat[k,"mpd.obs.z"]<-nri6[i,"mpd.obs.z"];nri.flat[k,"mpd.obs.p"]<-nri6[i,"mpd.obs.p"];nri.flat[k,"para.type"]<-as.character(nri6[i,"para.type"]);nri.flat[k,"tmode"]<-"nonclose";k<-k+1}
  if (nri6[i,"vector"]==1){nri.flat[k,"para.name"]<-nri6[i,"para.name"];nri.flat[k,"ntaxa"]<-nri6[i,"ntaxa"];nri.flat[k,"mpd.obs.z"]<-nri6[i,"mpd.obs.z"];nri.flat[k,"mpd.obs.p"]<-nri6[i,"mpd.obs.p"];nri.flat[k,"para.type"]<-as.character(nri6[i,"para.type"]);nri.flat[k,"tmode"]<-"vector";k<-k+1}
  if (nri6[i,"intermediate"]==1){nri.flat[k,"para.name"]<-nri6[i,"para.name"];nri.flat[k,"ntaxa"]<-nri6[i,"ntaxa"];nri.flat[k,"mpd.obs.z"]<-nri6[i,"mpd.obs.z"];nri.flat[k,"mpd.obs.p"]<-nri6[i,"mpd.obs.p"];nri.flat[k,"para.type"]<-as.character(nri6[i,"para.type"]);nri.flat[k,"tmode"]<-"intermediate";k<-k+1}
}


nri.prot <- nri %>% filter(ParType == "Protozoa") %>% select(protname = ParasiteCorrectedName, mpd.obs)

write_csv(nri.prot, "data/modified/mpd_prot.csv")

protraits_04 <- left_join(protraits_03, nri.prot)
```


